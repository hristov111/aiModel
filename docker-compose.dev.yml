# =============================================================================
# Docker Compose - DEVELOPMENT Configuration
# =============================================================================
# AI Companion Service - Development setup with hot-reload and code mounting
# 
# Usage:
#   docker-compose -f docker-compose.dev.yml up       # Start with logs
#   docker-compose -f docker-compose.dev.yml up -d    # Start in background
#   docker-compose -f docker-compose.dev.yml down     # Stop all services
#   docker-compose -f docker-compose.dev.yml logs -f  # View logs
#
# Features:
#   ‚úÖ Source code mounted as volumes (edit files ‚Üí instant reload)
#   ‚úÖ Hot-reload enabled (uvicorn --reload)
#   ‚úÖ Debug logging enabled
#   ‚úÖ Separate containers from production (can run both simultaneously)
#   ‚úÖ Fast startup (no rebuild needed for code changes)
#
# Perfect for:
#   - Active development
#   - Testing changes
#   - Debugging
#   - Learning the codebase
# =============================================================================

version: '3.8'

services:
  # ==========================================================================
  # PostgreSQL Database with pgvector extension
  # ==========================================================================
  postgres:
    image: pgvector/pgvector:pg15
    container_name: ai_companion_db_dev
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ${POSTGRES_DB:-ai_companion}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
      - ./backups:/backups  # For database backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-ai_companion}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ai_network_dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Redis - Caching and Distributed State
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: ai_companion_redis_dev
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data_dev:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - ai_network_dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # AI Companion Service - DEVELOPMENT MODE
  # ==========================================================================
  aiservice:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: ${BUILD_DATE:-2024-01-01}
        VERSION: ${VERSION:-dev}
        VCS_REF: ${VCS_REF:-development}
    image: ai-companion:dev
    container_name: ai_companion_service_dev
    ports:
      - "${APP_PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      # Database connection (using dev container)
      POSTGRES_URL: postgresql+asyncpg://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-ai_companion}
      # Redis connection (using dev container)
      REDIS_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/0
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      # Force development environment
      ENVIRONMENT: development
      LOG_LEVEL: DEBUG  # Verbose logging for development
      # Auto-run migrations on startup
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
      # Python settings
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      # =======================================================================
      # üî• SOURCE CODE MOUNTING - Edit these files and see changes instantly!
      # =======================================================================
      - ./app:/app/app:rw                         # Main application code
      - ./migrations:/app/migrations:rw            # Database migrations
      - ./alembic.ini:/app/alembic.ini:ro         # Alembic config
      - ./frontend:/app/frontend:rw                # Frontend files (if any)
      
      # =======================================================================
      # Logs and data persistence
      # =======================================================================
      - ./logs:/app/logs                          # Application logs
      - ./content_audit.log:/app/content_audit.log  # Content audit logs
      
      # =======================================================================
      # Optional: Mount tests for running inside container
      # =======================================================================
      # - ./tests:/app/tests:rw                   # Uncomment to mount tests
      # - ./pytest.ini:/app/pytest.ini:ro         # Uncomment for pytest config
    restart: unless-stopped
    networks:
      - ai_network_dev
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    # ==========================================================================
    # üî• DEVELOPMENT COMMAND - Enables hot-reload!
    # ==========================================================================
    # When you save a .py file, uvicorn automatically restarts the service
    command: [
      "uvicorn", 
      "app.main:app", 
      "--host", "0.0.0.0", 
      "--port", "8000", 
      "--reload",           # üî• Hot-reload enabled
      "--reload-dir", "/app/app",  # Watch app directory
      "--log-level", "debug"
    ]
    # Optional: Uncomment to override healthcheck for faster startup in dev
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    #   interval: 60s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 30s

  # ==========================================================================
  # Adminer - Database Visualization Tool (Development)
  # ==========================================================================
  adminer:
    image: adminer:latest
    container_name: ai_companion_adminer_dev
    ports:
      - "8080:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - ai_network_dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Networks - Separate from production to avoid conflicts
# =============================================================================
networks:
  ai_network_dev:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16  # Different subnet from production

# =============================================================================
# Volumes - Separate from production to avoid data conflicts
# =============================================================================
volumes:
  postgres_data_dev:
    driver: local
  redis_data_dev:
    driver: local

# =============================================================================
# DEVELOPMENT WORKFLOW
# =============================================================================
# 
# 1. START DEVELOPMENT:
#    docker-compose -f docker-compose.dev.yml up
#
# 2. MAKE CODE CHANGES:
#    Edit files in ./app/ directory
#    Save ‚Üí Service automatically reloads! ‚ú®
#
# 3. VIEW LOGS:
#    docker-compose -f docker-compose.dev.yml logs -f aiservice
#
# 4. RUN MIGRATIONS:
#    docker-compose -f docker-compose.dev.yml exec aiservice alembic upgrade head
#
# 5. ACCESS DATABASE:
#    Via Adminer: http://localhost:8080 (user: postgres, pass: changeme)
#    Via CLI: docker-compose -f docker-compose.dev.yml exec postgres psql -U postgres -d ai_companion
#
# 6. RUN TESTS (if tests mounted):
#    docker-compose -f docker-compose.dev.yml exec aiservice pytest tests/ -v
#
# 7. RESTART SERVICE ONLY:
#    docker-compose -f docker-compose.dev.yml restart aiservice
#
# 8. REBUILD IMAGE (if Dockerfile or requirements.txt changed):
#    docker-compose -f docker-compose.dev.yml build
#    docker-compose -f docker-compose.dev.yml up
#
# 9. STOP EVERYTHING:
#    docker-compose -f docker-compose.dev.yml down
#
# 10. STOP AND REMOVE VOLUMES (fresh start):
#     docker-compose -f docker-compose.dev.yml down -v
#
# =============================================================================
# TIPS & TRICKS
# =============================================================================
#
# ‚úÖ Code changes are instant - no rebuild needed!
# ‚úÖ Database persists between restarts (use -v flag to reset)
# ‚úÖ Can run alongside production docker-compose.yml (different ports)
# ‚úÖ Hot-reload works for .py files in ./app/ directory
# 
# ‚ö†Ô∏è  Changes to these files REQUIRE rebuild:
#    - Dockerfile
#    - requirements.txt
#    - docker-compose.dev.yml
#
# ‚ö†Ô∏è  Hot-reload limitations:
#    - Doesn't reload on .env changes (restart container)
#    - Doesn't reload on config file changes (restart container)
#    - May not catch syntax errors (check logs)
#
# üîß Debugging:
#    - Check logs: docker-compose -f docker-compose.dev.yml logs -f
#    - Enter container: docker-compose -f docker-compose.dev.yml exec aiservice bash
#    - Check health: curl http://localhost:8000/health
#
# =============================================================================
